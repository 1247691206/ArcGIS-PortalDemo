define(["dojo/_base/declare","dojo/_base/lang","dojo/text!esricdTmpl/buffer/bufferPanel.html","esri/map","esri/tasks/GeometryService","esri/SpatialReference","esri/tasks/BufferParameters","esri/config","esri/toolbars/draw","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/graphic","esri/layers/GraphicsLayer","esri/Color","dojo/_base/array","esri/tasks/query","esri/tasks/QueryTask"],function(e,r,t,a,i,s,o,n,f,p,l,u,c,h,b,y,m,d){return e(null,{__map:null,app:null,constructor:function(e){this.app=e,this.bindDomEvents()},startup:function(){console.log("buffer startup",this.app.config.itemInfo.itemData);var e=baidu.template(t,this.app.config.itemInfo.itemData);$("#bufferDiv").html(e);var r=new h({id:"bufferGraphics"});this.app.map.addLayer(r),this.initDraw()},bindDomEvents:function(){$("#bufferDiv").delegate("button[data-drawType]","click",$.proxy(function(e){var r=$(e.currentTarget).attr("data-drawType");if("BufferButton"==r){var t=$("#bufferDiv [node-type=bufferDistance]").val(),a=$("#bufferDiv [node-type=bufferDistanceUnitsSelect]").val();this.buffer(t,a)}else if(this.toolbar){var i=this.app.map.getLayer("bufferGraphics");i.clear(),this.toolbar.activate(esri.toolbars.Draw[r])}},this)),$("#bufferPanel").delegate("button[node-type]","click",$.proxy(function(e){var r=$(e.currentTarget).attr("node-type");if("hidePanel"==r){var t=this.app.map.getLayer("bufferGraphics");t.clear()}},this))},initDraw:function(){this.toolbar=new f(this.app.map,{tooltipOffset:20,drawTime:90}),this.toolbar.on("draw-end",$.proxy(function(e){switch(this.toolbar.deactivate(),e.geometry.type){case"point":case"multipoint":symbol=new p(p.STYLE_CIRCLE,10,new l(l.STYLE_SOLID,new b([0,0,0]),1),new b([0,0,0,.25]));break;case"polyline":symbol=new l;break;default:symbol=new u}var r=new c(e.geometry,symbol),t=this.app.map.getLayer("bufferGraphics");t.add(r)},this))},buffer:function(e,r){var t=this.app.map.getLayer("bufferGraphics");y.forEach(t.graphics,function(e){e.attributes&&t.remove(e)});var a=e.split(" ");if("ç±³"==r)for(var n=0;n<a.length;n++)a[n]=a[n]/1e3;if(a.length>0){var f=new o;f.distances=a,f.bufferSpatialReference=new s({wkid:102100}),f.outSpatialReference=this.app.map.spatialReference,f.unit=i.UNIT_STATUTE_MILE;var p=this.app.config.helperServices.geometry.url,l=new i(p);l.simplify([t.graphics[0].geometry],$.proxy(function(e){f.geometries=e,l.buffer(f,$.proxy(this.showBuffer,this))},this))}},showBuffer:function(e){var r=new u(u.STYLE_SOLID,new l(l.STYLE_SOLID,new b([255,0,0,.65]),2),new b([255,0,0,.35])),t=null;y.forEach(e,$.proxy(function(e){var a=new c(e,r,{buffer:!0});this.app.map.getLayer("bufferGraphics").add(a),t=e},this)),this.queryByGeometry(t)},queryByGeometry:function(e){console.log("bufferGeometry-geo:",e);var r=new m;r.returnGeometry=!1,r.outSpatialReference=this.app.map.spatialReference,r.outFields=["*"],r.geometry=e,r.distance=100;var t=$("#bufferDiv [node-type=bufferLayerSelect]").val();t.indexOf("MapServer")>=0&&t.indexOf("MapServer/")<0&&(t+="/0"),t.indexOf("FeatureServer")>=0&&t.indexOf("FeatureServer/")<0&&(t+="/0");var a=new d(t);this.app.dataTable.showLoading(),a.execute(r).then($.proxy(function(e){this.app.dataTable.showQueryResult(e,t),console.log("results:",e)},this))},test:""})});