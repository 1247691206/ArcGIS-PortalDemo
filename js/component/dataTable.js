define(["dojo/_base/declare","dojo/_base/lang","dgrid/Grid","dgrid/Selection","dgrid/extensions/ColumnHider","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/Color","esri/tasks/query","esri/tasks/QueryTask","dojo/text!esricdTmpl/mapinfo/baseinfo.html","dojo/text!esricdTmpl/mapinfo/layersinfo.html"],function(e,t,i,a,s,o,r,n,l,d,h,c,p,u){return e(null,{queryUrl:"",dataGrid:null,app:null,loadingHtml:"<img src='img/loading.gif' /> 操作执行中...",constructor:function(e){this.app=e,this.bindDomEvents()},startup:function(){},bindDomEvents:function(){$("#dataTableDiv").delegate("[node-type=hideBotPanel]","click",$.proxy(function(e){this.app.map.graphics.clear()},this))},show:function(){$("#dataTableDiv").css("bottom","0px")},showLoading:function(){this.dataGrid&&this.dataGrid.destroy(),$("#dataTableDiv #gridMessage").show().html(this.loadingHtml),$("#dataTableDiv").css("bottom","0px")},showLayerData:function(e){this.showLoading();var t=new h;t.returnGeometry=!1,t.outSpatialReference=this.app.map.spatialReference,t.outFields=["*"],t.where="0=0";var i=new c(e);i.execute(t).then($.proxy(function(t){console.log("query results",t),this.showQueryResult(t,e)},this),$.proxy(function(e){this.showError(e)},this))},showError:function(e){this.dataGrid&&this.dataGrid.destroy();var t="操作执行出现错误："+e.message;$("#dataTableDiv #gridMessage").show().html(t),$("#dataTableDiv").css("bottom","0px")},showQueryResult:function(t,o){this.queryUrl=o,$("#dataTableDiv #gridMessage").hide(),console.log("showQueryResult");var r=[];$.each(t.features,function(e,t){if(e>100)return!1;var i=t.attributes;i.__geometry=t.geometry,r.push(i)});var n=[];$.each(t.fields,function(e,t){var i=!1;e>5&&(i=!0),n.push({label:t.alias,field:t.name,hidden:i})}),this.dataGrid&&this.dataGrid.destroy();var l=$("<div></div>");$("#dataTableDiv #gridDiv").append(l),this.dataGrid=new(e([i,a,s]))({selectionMode:"single",allowTextSelection:!0,columns:n},l[0]),this.dataGrid.on("dgrid-select",$.proxy(function(e){console.log("dgrid-select-data:",e.rows[0].data);var t=(e.rows[0].data.__geometry,e.rows[0].data.OBJECTID||e.rows[0].data.objectid);this.highlightByOid(t)},this)),this.dataGrid.renderArray(r)},highlight:function(e){switch(console.log(e),e.type){case"point":case"multipoint":symbol=new r(r.STYLE_CIRCLE,10,new n(n.STYLE_SOLID,new d([255,0,0]),1),new d([255,0,0,.25]));break;case"polyline":symbol=new n;break;default:symbol=new l}var t=new o(e,symbol);this.app.map.graphics.clear(),this.app.map.graphics.add(t)},highlightByOid:function(e){console.log("highlightByOid");var t=new h;t.returnGeometry=!0,t.outSpatialReference=this.app.map.spatialReference,t.outFields=["*"],t.objectIds=[e],t.geometryPrecision=5;var i=new c(this.queryUrl);i.execute(t).then($.proxy(function(e){console.log("highlight sss");var t=e.features[0].geometry;this.highlight(t);var i=this.getCenterPoint(t);this.app.map.centerAt(i)},this),$.proxy(function(e){console.log(e)},this))},getCenterPoint:function(e){return"point"==e.type?e:e.getExtent().getCenter()},test:""})});