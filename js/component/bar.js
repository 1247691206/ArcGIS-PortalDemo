define(["dojo/_base/declare","dojo/_base/lang","dojo/on","esri/units","esri/dijit/BasemapGallery","esri/dijit/Geocoder","esri/dijit/Measurement","esri/dijit/Bookmarks","esri/SpatialReference","esri/geometry/Point","esri/symbols/PictureMarkerSymbol","esri/graphic","esri/tasks/IdentifyTask","esri/tasks/IdentifyParameters","esri/InfoTemplate"],function(e,t,a,i,n,r,s,o,l,p,c,d,h,m,u){return e(null,{measurement:null,app:null,mapClickHandler:null,constructor:function(e){this.app=e,this.bindDomEvents()},startup:function(){console.log("startup-bar"),this.initBasemapGallery(),this.initGeocoder(),this.initMeasurement(),this.initBookmark(),this.initIdentify()},bindDomEvents:function(){$("#esricdBar").delegate("button[data-rel-panel]","click",function(e){var t=$(e.currentTarget),a=$("#"+$(e.currentTarget).attr("data-rel-panel"));t.hasClass("active")?(t.removeClass("active"),a.hide(100)):($(".navbar button[data-rel-panel]").removeClass("active"),$(".navbar div[data-rel-btn]").hide(),t.addClass("active"),a.show(100))}),$("#esricdBar").delegate("[node-type=hideBarPanel],.esriBasemapGalleryThumbnail","click",function(e){var t=$(e.currentTarget).parents(".esricd-bar-panel"),a=$("#"+t.attr("data-rel-btn"));t.hide(100),a.removeClass("active")}),$("#esricdBar").delegate("button[data-rel-panel], button[node-type=hideBarPanel]","click",$.proxy(function(e){this.clearPrinterResult(),this.app.map&&this.app.map.graphics&&this.app.map.graphics.clear()},this)),$("#esricdBar").delegate("[node-type=toXyBtn]","click",$.proxy(function(e){this.app.map.graphics.clear();var t=$("[node-type=toXyInput]").val();t=t.replace("，",",");var a=t.split(",")[0],i=t.split(",")[1];if(!a||!i)return void alert("输入经纬度格式错误！");var n=new p(a,i,new l({wkid:4326})),r=new c("img/position.png",25,25),s=new d(n,r);this.app.map.centerAt(n),this.app.map.graphics.add(s)},this)),$("#esricdBar").delegate("#toolbarIdentifyBtn","click",$.proxy(function(e){var t=$(e.currentTarget).hasClass("active");t?this.disableIdentify():this.enableIdentify()},this))},clearPrinterResult:function(){if(this.measurement){this.measurement.clearResult();var e=this.measurement.getTool();e&&e.toolName&&this.measurement.setTool(e.toolName,!1)}},initBasemapGallery:function(){console.log(this);var e=this.app.config.sharinghost,t=new n({portalUrl:e,map:this.app.map},"basemapGalleryDiv");t.startup()},initGeocoder:function(){var e=new r({map:this.app.map,highlightLocation:!0,theme:"arcgisGeocoder"},"GeocoderDiv");e.startup()},initMeasurement:function(){console.log("Units:",i),this.measurement=new s({map:this.app.map,defaultAreaUnit:i.SQUARE_KILOMETERS,defaultLengthUnit:i.KILOMETERS},"measurementDiv"),this.measurement.startup()},initBookmark:function(){new o({map:this.app.map,bookmarks:[],editable:!0},"bookmarkDiv")},initIdentify:function(){},disableIdentify:function(){console.log("disableIdentify",this.mapClickHandler),this.mapClickHandler&&this.mapClickHandler.remove()},enableIdentify:function(){console.log("enableIdentify",this.mapClickHandler),this.mapClickHandler=a(this.app.map,"click",$.proxy(this.executeIdentifyTask,this))},executeIdentifyTask:function(e){var t=this.app.getMapserverUrls(),a=[];$.each(t,$.proxy(function(i,n){console.log("_url",n,t),a.push(this.identifyMapserverItem(n,e))},this)),this.app.map.infoWindow.setFeatures(a),this.app.map.infoWindow.show(e.mapPoint)},identifyMapserverItem:function(e,t){var a=new m;a.tolerance=3,a.layerOption=m.LAYER_OPTION_ALL,a.width=this.app.map.width,a.height=this.app.map.height,a.geometry=t.mapPoint,a.mapExtent=this.app.map.extent;var i=new h(e),n=i.execute(a).addCallback($.proxy(function(e){console.log("identifyTask res:",e);var t=[];return $.each(e,function(e,a){var i=a.layerName,n=new u(i,"${"+a.displayFieldName+"} <br/>ID: ${OBJECTID}"),r=a.feature;r.setInfoTemplate(n),t.push(r)}),t},this));return n},test:""})});