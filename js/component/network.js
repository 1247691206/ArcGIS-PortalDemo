define(["dojo/_base/declare","dojo/_base/lang","dojo/text!esricdTmpl/network/networkPanel.html","dojo/text!esricdTmpl/network/travelPolygon.html","dojo/text!esricdTmpl/network/recentlyPoint.html","dojo/text!esricdTmpl/network/route.html","esri/urlUtils","esri/map","esri/config","esri/tasks/ServiceAreaTask","esri/tasks/ServiceAreaParameters","esri/tasks/FeatureSet","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/geometry/Point","esri/graphic","esri/layers/GraphicsLayer","esri/renderers/SimpleRenderer","dojo/parser","dojo/dom","esri/Color","dojo/_base/array","esri/tasks/ClosestFacilityTask","esri/tasks/ClosestFacilityParameters","esri/tasks/query","esri/tasks/QueryTask","esri/tasks/RouteTask","esri/tasks/RouteParameters","esri/SpatialReference","esri/units","dojo/_base/connect","esri/toolbars/draw"],function(e,t,r,a,i,s,o,n,l,p,h,u,c,d,m,y,f,w,v,g,R,b,P,S,k,T,x,E,I,O,L,_,C){return e(null,{NO_NETWORK_SERVICE:"没有在portal中配置网络分析服务，无法使用路网分析功能",app:null,handler:null,ShortestAnalyst:null,RouteParas:null,graphicRoute:null,constructor:function(e){this.app=e},startup:function(){console.log("network startup");var e=baidu.template(r,this.app.config.itemInfo.itemData);$("#networkDiv").html(e);var t=baidu.template(a,this.app.config.itemInfo.itemData);$("#travelPolygonInfo").html(t);var o=baidu.template(i,this.app.config.itemInfo.itemData);$("#recentlyPointInfo").html(o);var n=baidu.template(s,this.app.config.itemInfo.itemData);$("#routeInfo").html(n),this.bindDomEvents(),this.initRoute(),this.initDraw()},bindDomEvents:function(){$("#travelPolygonInfo").delegate("[node-type=travelButton]","click",$.proxy(function(e){this.app.map.graphics.clear(),null!=this.handler&&this.handler.remove(),this.handler=this.app.map.on("click",$.proxy(this.mapClickHandler,this))},this)),$("#networkPanel").delegate("a[node-type]","click",$.proxy(function(e){$(e.currentTarget).attr("node-type"),null!=this.app&&(this.app.map.graphics.clear(),this.RouteParas.barriers=new u,this.RouteParas.stops=new u,null!=this.handler&&this.handler.remove())},this)),$("#networkPanel").delegate("button[node-type]","click",$.proxy(function(e){var t=$(e.currentTarget).attr("node-type");"hidePanel"==t&&null!=this.app&&(this.app.map.graphics.clear(),this.RouteParas.barriers=new u,this.RouteParas.stops=new u,null!=this.handler&&this.handler.remove())},this)),$("#recentlyPointInfo").delegate("[node-type=recentlyPointButton]","click",$.proxy(function(e){this.app.map.graphics.clear(),null!=this.handler&&this.handler.remove(),this.handler=this.app.map.on("click",$.proxy(this.recentPointMapClickHandler,this))},this)),$("#routeInfo").delegate("label[node-type]","click",$.proxy(function(e){var t=$(e.currentTarget).attr("node-type");"berthPointButton"==t?(null!=this.handler&&this.handler.remove(),this.handler=this.app.map.on("click",$.proxy(this.routeStopsMapClickHandler,this))):"fencePointButton"==t?(null!=this.handler&&this.handler.remove(),this.handler=this.app.map.on("click",$.proxy(this.routeBarriersMapClickHandler,this))):"fencePolylineButton"==t?(null!=this.handler&&this.handler.remove(),this.toolbar.activate(esri.toolbars.Draw.POLYLINE)):"fencePolygonButton"==t?(null!=this.handler&&this.handler.remove(),this.toolbar.activate(esri.toolbars.Draw.POLYGON)):"clearButton"==t&&null!=this.app&&(null!=this.handler&&this.handler.remove(),this.app.map.graphics.clear(),this.RouteParas.barriers=new u,this.RouteParas.stops=new u,this.RouteParas.polylineBarriers=new u,this.RouteParas.polygonBarriers=new u)},this)),$("#routeInfo").delegate("button[node-type=routeButton]","click",$.proxy(function(e){return this.ShortestAnalyst?void this.ShortestAnalyst.solve(this.RouteParas,$.proxy(this.showRoute,this),null):void alert(this.NO_NETWORK_SERVICE)},this))},mapClickHandler:function(e){if(!this.app.config.helperServices.route)return void alert(this.NO_NETWORK_SERVICE);var t=this.app.config.helperServices.route.url;t=t.replace("/Route","/Service Area");var r=new p(t),a=$("#travelPolygonInfo [node-type=travelTime]").val(),i=a.split(" "),s=$("#travelPolygonInfo [node-type=travelTimeType]").val();if("秒"==s)for(var o=0;o<i.length;o++)i[o]=i[o];else if("分钟"==s)for(var o=0;o<i.length;o++)i[o]=60*i[o];else if("小时"==s)for(var o=0;o<i.length;o++)i[o]=3600*i[o];for(var n=$("#travelPolygonInfo [node-type=heatLayerStepSelect]").val(),o=0;o<i.length;o++)i[o]=i[o]*n/1500;var l=new h;l.defaultBreaks=i,l.outSpatialReference=this.app.map.spatialReference,l.returnFacilities=!1,this.app.map.graphics.clear();var w=new c("diamond",20,new d("solid",new b([88,116,152]),2),new b([88,116,152,.2])),v=new y(e.mapPoint.x,e.mapPoint.y,this.app.map.spatialReference),g=new f(v,w);this.app.map.graphics.add(g);var R=[];R.push(g);var S=new u;S.features=R,l.facilities=S;var k=this.app.map;r.solve(l,function(e){var t=new m("solid",new d("solid",new b([232,104,80]),2),new b([232,104,80,.25]));P.forEach(e.serviceAreaPolygons,function(e){e.setSymbol(t),k.graphics.add(e)})},function(e){console.log(e.message)})},recentPointMapClickHandler:function(e){this.app.map.graphics.clear();var t=new c("diamond",20,new d("solid",new b([88,116,152]),2),new b([88,116,152,.2])),r=new y(e.mapPoint.x,e.mapPoint.y,this.app.map.spatialReference),a=new f(r,t);this.app.map.graphics.add(a);var i=new u,s=$("#recentlyPointInfo [node-type=LayerSelect]").val();s.indexOf("MapServer")>=0&&s.indexOf("MapServer/")<0&&(s=queryUrl+"/0"),s.indexOf("FeatureServer")>=0&&s.indexOf("FeatureServer/")<0&&(s+="/0");var o=new T;o.returnGeometry=!0,o.outSpatialReference=this.app.map.spatialReference,o.outFields=["*"],o.where="1=1";var n=new x(s);n.execute(o).then($.proxy(function(e){if(console.log("network layer results:",e),i.features=e.features,!this.app.config.helperServices.route)return void alert(this.NO_NETWORK_SERVICE);var t=this.app.config.helperServices.route.url;t=t.replace("/Route","/Closest%20Facility");var r=new S(t),s=new k;s.impedenceAttribute="Miles",s.defaultCutoff=7,s.returnIncidents=!1,s.returnRoutes=!0,s.returnDirections=!0,s.facilities=i,s.outSpatialReference=this.app.map.spatialReference;var o=[];o.push(a);var n=new u;n.features=o,s.incidents=n,this.app.map.graphics.enableMouseEvents();var l=this.app.map;r.solve(s,$.proxy(function(e){P.forEach(e.routes,function(t,r){var a=P.map(e.directions[r].features,function(e){return e.attributes.text}),i=new d(d.STYLE_SOLID,new b([89,95,35]),4);t.setSymbol(i),t.setAttributes(a),l.graphics.add(t)})},this))},this))},initRoute:function(){if(this.RouteParas=new I,this.app.config.helperServices.route){var e=this.app.config.helperServices.route.url;this.ShortestAnalyst=new E(e),this.RouteParas.barriers=new u,this.RouteParas.polylineBarriers=new u,this.RouteParas.polygonBarriers=new u,this.RouteParas.stops=new u,this.RouteParas.returnDirections=!1,this.RouteParas.returnRoutes=!0,this.RouteParas.outSpatialReference=this.app.map.SpatialReference}},routeStopsMapClickHandler:function(e){var t=e.mapPoint,r=new c("diamond",20,new d("solid",new b([88,116,152]),2),new b([88,116,152,.2])),a=new f(t,r);this.RouteParas.stops.features.push(a),this.app.map.graphics.add(a);var i=new esri.symbol.Font("18px",esri.symbol.Font.STYLE_NORMAL,esri.symbol.Font.VARIANT_NORMAL,esri.symbol.Font.WEIGHT_BOLDER),s=new esri.symbol.TextSymbol("停靠点",i,new dojo.Color([200,30,30]));this.app.map.graphics.add(new f(t,s))},routeBarriersMapClickHandler:function(e){var t=e.mapPoint,r=new c("diamond",20,new d("solid",new b([88,116,152]),2),new b([88,116,152,.2])),a=new f(t,r);this.RouteParas.barriers.features.push(a),this.app.map.graphics.add(a);var i=new esri.symbol.Font("18px",esri.symbol.Font.STYLE_NORMAL,esri.symbol.Font.VARIANT_NORMAL,esri.symbol.Font.WEIGHT_BOLDER),s=new esri.symbol.TextSymbol("障碍点",i,new dojo.Color([200,30,30]));this.app.map.graphics.add(new f(t,s))},initDraw:function(){this.toolbar=new C(this.app.map,{tooltipOffset:20,drawTime:90}),this.toolbar.on("draw-end",$.proxy(function(e){switch(this.toolbar.deactivate(),e.geometry.type){case"point":case"multipoint":symbol=new c(c.STYLE_CIRCLE,10,new d(d.STYLE_SOLID,new b([200,30,30]),1),new b([200,30,30,.25]));break;case"polyline":symbol=new d;break;default:symbol=new m}var t=new f(e.geometry,symbol);this.app.map.graphics.add(t),"polyline"==e.geometry.type?this.RouteParas.polylineBarriers.features.push(t):"polygon"==e.geometry.type&&this.RouteParas.polygonBarriers.features.push(t)},this))},showRoute:function(e){var t=e.routeResults,r=t.length;if(null!=this.graphicRoute&&this.app.map.graphics.remove(this.graphicRoute),r>0)for(var a=0;r>a;a++){var i=t[a],s=i.route,o=new d(d.STYLE_SOLID,new b([89,95,35]),4);s.setSymbol(o),this.app.map.graphics.add(s),this.graphicRoute=s}else alert("没有返回结果")},test:""})});