define(["dojo/_base/declare","dojo/_base/lang","dojo/text!esricdTmpl/heatmap/heatmapPanel.html","dojo/text!esricdTmpl/heatmap/heatmapFiled.html","esri/InfoTemplate","esri/layers/FeatureLayer","esri/map","esri/renderers/HeatmapRenderer"],function(e,a,t,r,i,n,l,o){return e(null,{app:null,constructor:function(e){this.app=e,this.bindDomEvents()},startup:function(){console.log("heatmap startup");var e=baidu.template(t,this.app.config.itemInfo.itemData);$("#heatmapDiv").html(e),this.refreshRulesDivByLayer()},bindDomEvents:function(){var e,a=new o({colors:["rgba(0, 0, 255, 0)","rgb(0, 0, 255)","rgb(255, 0, 255)","rgb(255, 0, 0)"],blurRadius:20,field:null,maxPixelIntensity:240,minPixelIntensity:3});$("#heatmapDiv").delegate("input[data-Type]","change",$.proxy(function(t){var r=$(t.currentTarget).attr("data-Type");if("blurControl"==r){var i=+t.target.value;i!==a.blurRadius&&(a.blurRadius=i,e.redraw())}else if("maxControl"==r){var i=+t.target.value;i!==a.maxPixelIntensity&&(a.maxPixelIntensity=i,e.redraw())}else if("minControl"==r){var i=+t.target.value;i!==a.minPixelIntensity&&(a.minPixelIntensity=i,e.redraw())}},this)),$("#heatmapDiv").delegate("button[data-drawType]","click",$.proxy(function(t){var r=$(t.currentTarget).attr("data-drawType");if("HeatButton"==r){var i=this.app.map.getLayer("heatmapFeatureLayer");void 0!=i&&this.app.map.removeLayer(i);var l=this.getServiceUrl(),o={mode:n.MODE_SNAPSHOT,infoTemplate:null,outFields:["*"]};$.getJSON(l+"?f=json&callback=?",$.proxy(function(t){if("esriGeometryPoint"==t.geometryType){e=new n(l,o),e.id="heatmapFeatureLayer";var r=$("#heatmapDiv [node-type=countFiled]").val();"无计数字段"!=r?a.field=r:a.field=null,e.setRenderer(a),this.app.map.addLayer(e)}else alert("所选图层不是点图层，无法进行热度分析")},this))}},this)),$("#heatmapPanel").delegate("button[node-type]","click",$.proxy(function(e){var a=$(e.currentTarget).attr("node-type");if("hidePanel"==a&&null!=this.app){var t=this.app.map.getLayer("heatmapFeatureLayer");null!=t&&this.app.map.removeLayer(t)}},this)),$("#heatmapPanel").delegate("[node-type=heatLayerSelect]","change",$.proxy(function(e){this.refreshRulesDivByLayer();var a=this.getServiceUrl();$.getJSON(a+"?f=json&callback=?",$.proxy(function(e){"esriGeometryPoint"!=e.geometryType&&alert("所选图层不是点图层，无法进行热度分析")},this))},this))},getServiceUrl:function(){var e=$("#heatmapDiv [node-type=heatLayerSelect]").val();return e.indexOf("MapServer")>=0&&e.indexOf("MapServer/")<0&&(e+="/0"),e.indexOf("FeatureServer")>=0&&e.indexOf("FeatureServer/")<0&&(e+="/0"),e},dosth:function(){},refreshRulesDivByLayer:function(){var e=$("#heatmapDiv [node-type=heatLayerSelect]").val();e&&(e.indexOf("MapServer")>=0&&e.indexOf("MapServer/")<0&&(e+="/0"),e.indexOf("FeatureServer")>=0&&e.indexOf("FeatureServer/")<0&&(e+="/0"),console.log("layer changed:",e),$.ajax({data:{f:"json"},type:"GET",url:e,dataType:"jsonp"}).then(function(e){var a=baidu.template(r,e);$("#heatmapDiv [node-type=rulesAboutDiv]").html(a)}))},test:""})});