define(["dojo/Evented","dojo/_base/declare","dojo/_base/kernel","dojo/_base/array","dojo/_base/lang","dojo/dom-class","dojo/Deferred","dojo/promise/all","esri/arcgis/utils","esri/urlUtils","esri/request","esri/config","esri/lang","esri/IdentityManager","esri/arcgis/Portal","esri/arcgis/OAuthInfo","esri/tasks/GeometryService","config/defaults","dojo/string"],function(i,e,t,o,r,n,s,a,c,h,u,g,l,f,p,m,d,v,y){return e([i],{config:{},orgConfig:{},appConfig:{},urlConfig:{},customUrlConfig:{},commonConfig:{},constructor:function(i){var e={queryForWebmap:!0};this.templateConfig=r.mixin(e,i),this.config=v},startup:function(){var i=this._init();return i.then(r.hitch(this,function(i){this.emit("ready",i)}),r.hitch(this,function(i){this.emit("error",i)})),i},_init:function(){var i,e;return i=new s,e=["webmap","appid","group","oauthappid"],this.urlConfig=this._createUrlParamsObject(e),r.mixin(this.config,this.urlConfig),this._initializeApplication(),a({auth:this._checkSignIn(),i18n:this._getLocalization(),app:this._queryApplicationConfiguration(),common:this._getCommonConfig(),portal:this._createPortal()}).then(r.hitch(this,function(){a({item:this._queryDisplayItem(),groupInfo:this._queryGroupInfo(),groupItems:this.queryGroupItems(),org:this._queryOrganizationInformation()}).then(r.hitch(this,function(){this._queryUrlParams(),r.mixin(this.config,this.commonConfig,this.orgConfig,this.appConfig,this.customUrlConfig,this.urlConfig),this.config.helperServices&&this.config.helperServices.geometry&&this.config.helperServices.geometry.url&&(g.defaults.geometryService=new d(this.config.helperServices.geometry.url)),i.resolve(this.config)}),i.reject)}),i.reject),i.promise},_createPortal:function(){var i=new s;return this.templateConfig.queryForGroupInfo||this.templateConfig.queryForGroupItems?(this.portal=new p.Portal(this.config.sharinghost),this.portal.on("load",function(){i.resolve()})):i.resolve(),i.promise},_getCommonConfig:function(){var i;return i=new s,this.templateConfig.queryForCommonConfig?require(["arcgis_templates/commonConfig"],r.hitch(this,function(e){this.commonConfig=e,i.resolve(e)})):i.resolve(),i.promise},_createUrlParamsObject:function(i){var e,t,o,r={};if(o=document.location.href,e=h.urlToObject(o),e.query=e.query||{},e.query&&i&&i.length)for(t=0;t<i.length;t++)e.query[i[t]]&&(r[i[t]]=e.query[i[t]]);return r},_initializeApplication:function(){var i,e;i=location.pathname.indexOf("/apps/"),-1===i&&(i=location.pathname.indexOf("/home/")),-1!==i&&(e=location.pathname.substr(0,i),this.config.sharinghost=location.protocol+"//"+location.host+e,this.config.proxyurl=location.protocol+"//"+location.host+e+"/sharing/proxy"),c.arcgisUrl=this.config.sharinghost+"/sharing/rest/content/items",this.config.proxyurl&&(g.defaults.io.proxyUrl=this.config.proxyurl,g.defaults.io.alwaysUseProxy=!1)},_checkSignIn:function(){var i,e,t;return i=new s,this.config.oauthappid&&(t=new m({appId:this.config.oauthappid,portalUrl:this.config.sharinghost,popup:!0}),f.registerOAuthInfos([t])),e=f.checkSignInStatus(this.config.sharinghost+"/sharing"),e.promise.always(function(){i.resolve()}),i.promise},_getLocalization:function(){var i,e,a,c;return i=new s,this.templateConfig.queryForLocale?require(["dojo/i18n!application/nls/resources"],r.hitch(this,function(s){this.config.i18n=s||{},this.config.i18n.direction="ltr",o.some(["ar","he"],r.hitch(this,function(i){return-1!==t.locale.indexOf(i)?(this.config.i18n.direction="rtl",!0):!1})),e=document.getElementsByTagName("html")[0],a=e.className,"rtl"===this.config.i18n.direction?(e.setAttribute("dir","rtl"),c=" esriRTL dj_rtl dijitRtl "+a.replace(/ /g,"-rtl "),e.className=r.trim(a+c)):(e.setAttribute("dir","ltr"),n.add(e,"esriLTR")),i.resolve(s)})):i.resolve(),i.promise},queryGroupItems:function(i){var e,t,o,n=new s;return this.templateConfig.queryForGroupItems?this.config.group?(t={q:'group:"${groupid}" AND -type:"Code Attachment"',sortField:"modified",sortOrder:"desc",num:9,start:0,f:"json"},o=r.mixin(t,this.templateConfig.groupParams,i),o.q&&(o.q=y.substitute(o.q,{groupid:this.config.group})),this.portal.queryItems(o).then(r.hitch(this,function(i){this.config.groupItems=i,n.resolve(i)}),function(i){n.reject(i)})):(e=new Error("Group undefined."),n.reject(e)):n.resolve(),n.promise},_queryGroupInfo:function(){var i,e,t=new s;return this.templateConfig.queryForGroupInfo?this.config.group?(e={q:'id:"'+this.config.group+'"',f:"json"},this.portal.queryGroups(e).then(r.hitch(this,function(i){this.config.groupInfo=i,t.resolve(i)}),function(i){t.reject(i)})):(i=new Error("Group undefined."),t.reject(i)):t.resolve(),t.promise},_queryDisplayItem:function(){var i;return i=new s,this.templateConfig.queryForWebmap?(this.config.webmap||(this.config.webmap="24e01ef45d40423f95300ad2abc5038a"),c.getItem(this.config.webmap).then(r.hitch(this,function(e){this.config.appid&&this.config.application_extent.length>0&&e.item.extent&&(e.item.extent=[[parseFloat(this.config.application_extent[0][0]),parseFloat(this.config.application_extent[0][1])],[parseFloat(this.config.application_extent[1][0]),parseFloat(this.config.application_extent[1][1])]]),console.log("-------itemInfo:",e),this.config.itemInfo=e,i.resolve(e)}),function(e){e||(e=new Error("Error retrieving display item.")),i.reject(e)})):i.resolve(),i.promise},_queryApplicationConfiguration:function(){var i=new s;return this.config.appid?c.getItem(this.config.appid).then(r.hitch(this,function(e){if(e.item&&e.itemData&&e.itemData.values){this.appConfig=e.itemData.values,this.appResponse=e;var t=this._createUrlParamsObject(["webmap"]);l.isDefined(t.webmap)||""!==e.itemData.values.webmap&&(this.config.webmap=e.itemData.values.webmap)}e.item&&e.item.extent&&(this.config.application_extent=e.item.extent),i.resolve(e)}),function(e){e||(e=new Error("Error retrieving application configuration.")),i.reject(e)}):i.resolve(),i.promise},_queryOrganizationInformation:function(){var i=new s;return this.templateConfig.queryForOrg?u({url:this.config.sharinghost+"/sharing/rest/portals/self",content:{f:"json"},callbackParamName:"callback"}).then(r.hitch(this,function(e){this.config.orgInfo=e,this.orgConfig.units="metric",e.user&&e.user.units?this.orgConfig.units=e.user.units:e.units?this.orgConfig.units=e.units:(e.user&&e.user.region&&"US"===e.user.region||e.user&&!e.user.region&&"US"===e.region||e.user&&!e.user.region&&!e.region||!e.user&&"US"===e.ipCntryCode||!e.user&&!e.ipCntryCode&&"en-us"===t.locale)&&(this.orgConfig.units="english"),this.orgConfig.helperServices=e.helperServices,e.user&&l.isDefined(e.user.roleId)&&e.user.privileges&&(this.orgConfig.userPrivileges=e.user.privileges),i.resolve(e)}),function(e){e||(e=new Error("Error retrieving organization information.")),i.reject(e)}):i.resolve(),i.promise},_queryUrlParams:function(){this.customUrlConfig=this._createUrlParamsObject(this.templateConfig.urlItems)}})});